name: "Build and Release"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: false
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        type: boolean
        default: false
  push:
    tags:
      - "v*"

jobs:
  # 代码质量检查
  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Type check
        run: npx tsc --noEmit

      - name: Lint
        run: npm run lint || echo "Lint script not found, skipping..."

      - name: Build frontend
        run: npm run build

  publish-electron:
    name: Build and Release Electron (${{ matrix.platform }})
    permissions:
      contents: write
    needs: [lint-and-build]
    if: always() && (needs.lint-and-build.result == 'success' || needs.lint-and-build.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-15"
          - platform: "ubuntu-22.04"
          - platform: "windows-latest"
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libfuse2 libgconf-2-4 rpm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install frontend dependencies
        run: npm install --prefer-offline --no-audit

      - name: Ensure preload renaming script works
        run: node scripts/ensure-preload-cjs.mjs

      - name: Update version in package.json
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION="${VERSION#v}"
          CURRENT=$(node -p "require('./package.json').version")
          if [ "$CURRENT" = "$VERSION" ]; then
            echo "Version unchanged ($CURRENT), skip."
            exit 0
          fi
          npm version "$VERSION" --no-git-tag-version

      - name: Build Electron app
        env:
          NODE_ENV: production
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run electron:build

      - name: Get release info
        id: release_info
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION="${VERSION#v}"
          TAG_NAME="${{ steps.version.outputs.version }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "release_name=Kit ${VERSION}" >> $GITHUB_OUTPUT

      - name: Upload release artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.dmg
            release/*.exe
            release/*.AppImage
            release/*.deb
            release/*.rpm
            release/*.zip
            release/*.tar.gz
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: ${{ steps.release_info.outputs.release_name }}
          body: |
            Release ${{ steps.release_info.outputs.release_name }}

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          make_latest: ${{ matrix.platform == 'macos-15' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
